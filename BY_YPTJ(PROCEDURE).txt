BY_YPTJ	PROCEDURE	1	"PROCEDURE         ""BY_YPTJ"" (
"
BY_YPTJ	PROCEDURE	2	"        P_TJDH   IN VARCHAR2,
"
BY_YPTJ	PROCEDURE	3	"        P_ZXR    IN VARCHAR2,
"
BY_YPTJ	PROCEDURE	4	"        P_DATE   IN VARCHAR2,
"
BY_YPTJ	PROCEDURE	5	"        P_XTXH   IN NUMBER) IS
"
BY_YPTJ	PROCEDURE	6	"BEGIN
"
BY_YPTJ	PROCEDURE	7	"DECLARE
"
BY_YPTJ	PROCEDURE	8	"
"
BY_YPTJ	PROCEDURE	9	"   V_CRKFSDM    NUMBER(2) := 21;
"
BY_YPTJ	PROCEDURE	10	"
"
BY_YPTJ	PROCEDURE	11	"   V_YPLX	NUMBER(1);
"
BY_YPTJ	PROCEDURE	12	"   V_YPLX_YF	NUMBER(1);
"
BY_YPTJ	PROCEDURE	13	"   V_YFLB	NUMBER(1) := 2; -- 1 门诊药房 2 病区药房
"
BY_YPTJ	PROCEDURE	14	"
"
BY_YPTJ	PROCEDURE	15	"   V_JGXH	NUMBER;
"
BY_YPTJ	PROCEDURE	16	"   V_YPXH	NUMBER(6);
"
BY_YPTJ	PROCEDURE	17	"   V_YPCDDM	NUMBER(4);
"
BY_YPTJ	PROCEDURE	18	"   V_XH		NUMBER;
"
BY_YPTJ	PROCEDURE	19	"   V_TJSL	NUMBER;
"
BY_YPTJ	PROCEDURE	20	"   V_YPFJ	NUMBER;
"
BY_YPTJ	PROCEDURE	21	"   V_YLSJ	NUMBER;
"
BY_YPTJ	PROCEDURE	22	"   V_XPFJ	NUMBER;
"
BY_YPTJ	PROCEDURE	23	"   V_XLSJ	NUMBER;
"
BY_YPTJ	PROCEDURE	24	"   V_ZBLB	NUMBER(2);
"
BY_YPTJ	PROCEDURE	25	"   V_TJWH	VARCHAR2(30);
"
BY_YPTJ	PROCEDURE	26	"   V_YPBZL	NUMBER(4);
"
BY_YPTJ	PROCEDURE	27	"   V_LSTJJE	NUMBER;
"
BY_YPTJ	PROCEDURE	28	"   V_LSJTJ	NUMBER;
"
BY_YPTJ	PROCEDURE	29	"
"
BY_YPTJ	PROCEDURE	30	"   V_YPSX	CHAR(11);
"
BY_YPTJ	PROCEDURE	31	"
"
BY_YPTJ	PROCEDURE	32	"   V_BYKC	NUMBER(14,4);
"
BY_YPTJ	PROCEDURE	33	"   V_BYKC_FZ	NUMBER(14,4);
"
BY_YPTJ	PROCEDURE	34	"
"
BY_YPTJ	PROCEDURE	35	"   V_YFXTXH	NUMBER(2);
"
BY_YPTJ	PROCEDURE	36	"   V_FLAG       NUMBER(1) := 0;
"
BY_YPTJ	PROCEDURE	37	"   V_ZXRQ	DATE;
"
BY_YPTJ	PROCEDURE	38	"   V_CRKDM	BY_CRKFS.CRKDM %TYPE;
"
BY_YPTJ	PROCEDURE	39	"   V_KSDM	BY_CRKFS.KSDM %TYPE;
"
BY_YPTJ	PROCEDURE	40	"   V_TJDH	BY_CRKFS.DQDH %TYPE;
"
BY_YPTJ	PROCEDURE	41	"
"
BY_YPTJ	PROCEDURE	42	"   E_TJDHNOTFOUND EXCEPTION;
"
BY_YPTJ	PROCEDURE	43	"   E_KSDMNOTFOUND EXCEPTION;
"
BY_YPTJ	PROCEDURE	44	"
"
BY_YPTJ	PROCEDURE	45	"   CURSOR CUR_YFXH IS
"
BY_YPTJ	PROCEDURE	46	"    SELECT B.XTXH,A.YPLX FROM YF_YPLXDZ A,YF_XTDZ B 
"
BY_YPTJ	PROCEDURE	47	"    WHERE A.XTXH = B.XTXH AND A.YKXH= P_XTXH AND B.YFLB =  V_YFLB
"
BY_YPTJ	PROCEDURE	48	"          AND A.XTXH IN (SELECT XTXH FROM BY_CKXH WHERE KSSX = 1);
"
BY_YPTJ	PROCEDURE	49	"
"
BY_YPTJ	PROCEDURE	50	"--          AND A.XTXH = C.XTXH AND C.USEFLAG = 1;	
"
BY_YPTJ	PROCEDURE	51	"
"
BY_YPTJ	PROCEDURE	52	"   CURSOR CUR_TJYP IS 
"
BY_YPTJ	PROCEDURE	53	"    SELECT JGXH,YPXH,YPCDDM,XH,YPFJ,YLSJ,XPFJ,XLSJ,ZBLB
"
BY_YPTJ	PROCEDURE	54	"    FROM YK_YKTJDMX WHERE XTXH = P_XTXH AND TJDH = P_TJDH ORDER BY XH;
"
BY_YPTJ	PROCEDURE	55	"
"
BY_YPTJ	PROCEDURE	56	"BEGIN
"
BY_YPTJ	PROCEDURE	57	"
"
BY_YPTJ	PROCEDURE	58	"   UPDATE GY_XTCS SET CSZ1=NULL WHERE XTXH=P_XTXH AND CSMC='TJDH' ;
"
BY_YPTJ	PROCEDURE	59	"--   COMMIT ;
"
BY_YPTJ	PROCEDURE	60	"
"
BY_YPTJ	PROCEDURE	61	"--GET ZXRQ
"
BY_YPTJ	PROCEDURE	62	"   SELECT SYSDATE INTO V_ZXRQ FROM DUAL;
"
BY_YPTJ	PROCEDURE	63	"
"
BY_YPTJ	PROCEDURE	64	"--获取调价文号
"
BY_YPTJ	PROCEDURE	65	"   BEGIN     
"
BY_YPTJ	PROCEDURE	66	"     SELECT NVL(TJWH,'') INTO V_TJWH
"
BY_YPTJ	PROCEDURE	67	"     FROM YK_YKTJD 
"
BY_YPTJ	PROCEDURE	68	"     WHERE XTXH = P_XTXH AND TJDH = P_TJDH;
"
BY_YPTJ	PROCEDURE	69	"     EXCEPTION    
"
BY_YPTJ	PROCEDURE	70	"	WHEN OTHERS THEN  -- handles all other errors
"
BY_YPTJ	PROCEDURE	71	"        V_TJWH := '获取调价文号错误';
"
BY_YPTJ	PROCEDURE	72	"   END;
"
BY_YPTJ	PROCEDURE	73	"
"
BY_YPTJ	PROCEDURE	74	"---- START
"
BY_YPTJ	PROCEDURE	75	"  OPEN CUR_YFXH;
"
BY_YPTJ	PROCEDURE	76	"  LOOP
"
BY_YPTJ	PROCEDURE	77	"    FETCH CUR_YFXH INTO V_YFXTXH,V_YPLX_YF;
"
BY_YPTJ	PROCEDURE	78	"    EXIT WHEN CUR_YFXH%NOTFOUND;
"
BY_YPTJ	PROCEDURE	79	"
"
BY_YPTJ	PROCEDURE	80	"    V_CRKDM := 83;
"
BY_YPTJ	PROCEDURE	81	"
"
BY_YPTJ	PROCEDURE	82	"
"
BY_YPTJ	PROCEDURE	83	"----modi 2003/10/16  
"
BY_YPTJ	PROCEDURE	84	" BEGIN
"
BY_YPTJ	PROCEDURE	85	"    SELECT KSDM INTO V_KSDM
"
BY_YPTJ	PROCEDURE	86	"    FROM BY_CKXH WHERE XTXH = V_YFXTXH AND KSSX = 1 AND ROWNUM = 1;
"
BY_YPTJ	PROCEDURE	87	"    EXCEPTION      
"
BY_YPTJ	PROCEDURE	88	"     WHEN OTHERS THEN  -- handles all other errors
"
BY_YPTJ	PROCEDURE	89	"	  RAISE E_KSDMNOTFOUND;
"
BY_YPTJ	PROCEDURE	90	" END;
"
BY_YPTJ	PROCEDURE	91	"
"
BY_YPTJ	PROCEDURE	92	"----GET TJDH
"
BY_YPTJ	PROCEDURE	93	"  BEGIN
"
BY_YPTJ	PROCEDURE	94	"     SELECT NVL(LPAD(DQDH+1,10,'0'),'0000000001') INTO V_TJDH
"
BY_YPTJ	PROCEDURE	95	"     FROM BY_CRKFS WHERE XTXH = V_YFXTXH AND CRKDM = V_CRKDM AND KSDM = V_KSDM;
"
BY_YPTJ	PROCEDURE	96	"     EXCEPTION      
"
BY_YPTJ	PROCEDURE	97	"        WHEN OTHERS THEN  -- handles all other errors
"
BY_YPTJ	PROCEDURE	98	"	  RAISE E_TJDHNOTFOUND;
"
BY_YPTJ	PROCEDURE	99	"  END;  
"
BY_YPTJ	PROCEDURE	100	"
"
BY_YPTJ	PROCEDURE	101	"  UPDATE BY_CRKFS 
"
BY_YPTJ	PROCEDURE	102	"  SET DQDH = V_TJDH
"
BY_YPTJ	PROCEDURE	103	"  WHERE XTXH = V_YFXTXH AND CRKDM = V_CRKDM ;
"
BY_YPTJ	PROCEDURE	104	"
"
BY_YPTJ	PROCEDURE	105	"  --BEGIN
"
BY_YPTJ	PROCEDURE	106	"  --  SELECT KSDM INTO V_KSDM
"
BY_YPTJ	PROCEDURE	107	"  --  FROM BY_CKXH WHERE XTXH = V_YFXTXH AND KSSX = 1 AND ROWNUM = 1;
"
BY_YPTJ	PROCEDURE	108	"   -- EXCEPTION      
"
BY_YPTJ	PROCEDURE	109	"   --   WHEN OTHERS THEN  -- handles all other errors
"
BY_YPTJ	PROCEDURE	110	"---	  RAISE E_KSDMNOTFOUND;
"
BY_YPTJ	PROCEDURE	111	" -- END;
"
BY_YPTJ	PROCEDURE	112	"
"
BY_YPTJ	PROCEDURE	113	"  INSERT INTO BY_TJD(XTXH,TJDH,TJWH,ZXRQ,ZXR,YKXTXH,YKCRKFSDM,YKCRKDH)
"
BY_YPTJ	PROCEDURE	114	"  VALUES(V_YFXTXH,V_TJDH,V_TJWH,V_ZXRQ,P_ZXR,P_XTXH,V_CRKFSDM,P_TJDH);
"
BY_YPTJ	PROCEDURE	115	"
"
BY_YPTJ	PROCEDURE	116	"
"
BY_YPTJ	PROCEDURE	117	"---GET TJYP
"
BY_YPTJ	PROCEDURE	118	"----------------------------------------------------------------------------------------
"
BY_YPTJ	PROCEDURE	119	"  OPEN CUR_TJYP;
"
BY_YPTJ	PROCEDURE	120	"  LOOP
"
BY_YPTJ	PROCEDURE	121	"    FETCH CUR_TJYP INTO V_JGXH,V_YPXH,V_YPCDDM,V_XH,V_YPFJ,V_YLSJ,V_XPFJ,V_XLSJ,V_ZBLB;
"
BY_YPTJ	PROCEDURE	122	"    EXIT WHEN CUR_TJYP%NOTFOUND;
"
BY_YPTJ	PROCEDURE	123	"
"
BY_YPTJ	PROCEDURE	124	"-- GET YPSX
"
BY_YPTJ	PROCEDURE	125	"      BEGIN     
"
BY_YPTJ	PROCEDURE	126	"        SELECT YPSX INTO V_YPSX FROM GY_YPCDJG WHERE XH = V_JGXH;
"
BY_YPTJ	PROCEDURE	127	"        EXCEPTION    
"
BY_YPTJ	PROCEDURE	128	"	   WHEN OTHERS THEN  -- handles all other errors
"
BY_YPTJ	PROCEDURE	129	"	   V_YPSX := '00000000000';  --错误
"
BY_YPTJ	PROCEDURE	130	"      END;
"
BY_YPTJ	PROCEDURE	131	" 
"
BY_YPTJ	PROCEDURE	132	"      IF SUBSTR(V_YPSX,2,1) = '1' THEN
"
BY_YPTJ	PROCEDURE	133	"	 V_YPLX := 1;  --西药
"
BY_YPTJ	PROCEDURE	134	"      ELSIF SUBSTR(V_YPSX,5,1) = '1' THEN
"
BY_YPTJ	PROCEDURE	135	"	 V_YPLX := 2;  --中成药
"
BY_YPTJ	PROCEDURE	136	"      ELSIF SUBSTR(V_YPSX,8,1) = '1' THEN
"
BY_YPTJ	PROCEDURE	137	"	 V_YPLX := 4;  --草药
"
BY_YPTJ	PROCEDURE	138	"      ELSE
"
BY_YPTJ	PROCEDURE	139	"         V_YPLX := 0;  --错误
"
BY_YPTJ	PROCEDURE	140	"      END IF;
"
BY_YPTJ	PROCEDURE	141	"
"
BY_YPTJ	PROCEDURE	142	"
"
BY_YPTJ	PROCEDURE	143	"      IF (V_YPLX = 0) OR (V_YPLX <> V_YPLX_YF) THEN
"
BY_YPTJ	PROCEDURE	144	"         NULL;
"
BY_YPTJ	PROCEDURE	145	"      ELSE
"
BY_YPTJ	PROCEDURE	146	"
"
BY_YPTJ	PROCEDURE	147	"-- GET YPBZL
"
BY_YPTJ	PROCEDURE	148	"      BEGIN     
"
BY_YPTJ	PROCEDURE	149	"        SELECT YPBZL INTO V_YPBZL
"
BY_YPTJ	PROCEDURE	150	"        FROM GY_YPMCGGZD
"
BY_YPTJ	PROCEDURE	151	"        WHERE YPXH = V_YPXH;
"
BY_YPTJ	PROCEDURE	152	"        EXCEPTION    
"
BY_YPTJ	PROCEDURE	153	"	   WHEN OTHERS THEN  -- handles all other errors
"
BY_YPTJ	PROCEDURE	154	"           V_YPBZL := 1;
"
BY_YPTJ	PROCEDURE	155	"      END;
"
BY_YPTJ	PROCEDURE	156	"
"
BY_YPTJ	PROCEDURE	157	"---- 住院药房				
"
BY_YPTJ	PROCEDURE	158	"BEGIN
"
BY_YPTJ	PROCEDURE	159	"   SELECT NVL(SUM(NVL(SKC,0)) - SUM(NVL(XSKC,0)),0) INTO V_BYKC
"
BY_YPTJ	PROCEDURE	160	"   FROM BY_YPKCZ  WHERE XTXH = V_YFXTXH AND YPXH = V_YPXH AND YPCDDM = V_YPCDDM ;
"
BY_YPTJ	PROCEDURE	161	"
"
BY_YPTJ	PROCEDURE	162	"   EXCEPTION      
"
BY_YPTJ	PROCEDURE	163	"	   WHEN NO_DATA_FOUND THEN
"
BY_YPTJ	PROCEDURE	164	"   V_BYKC := 0;
"
BY_YPTJ	PROCEDURE	165	"END;
"
BY_YPTJ	PROCEDURE	166	"
"
BY_YPTJ	PROCEDURE	167	"BEGIN
"
BY_YPTJ	PROCEDURE	168	"   SELECT NVL(SUM(NVL(SKC,0)) - SUM(NVL(XSKC,0)),0) INTO V_BYKC_FZ
"
BY_YPTJ	PROCEDURE	169	"   FROM BY_YPKCZ  WHERE XTXH = V_YFXTXH AND FZFL = V_YPXH AND YPCDDM = V_YPCDDM ;
"
BY_YPTJ	PROCEDURE	170	"
"
BY_YPTJ	PROCEDURE	171	"   EXCEPTION      
"
BY_YPTJ	PROCEDURE	172	"	   WHEN NO_DATA_FOUND THEN
"
BY_YPTJ	PROCEDURE	173	"   V_BYKC_FZ := 0;
"
BY_YPTJ	PROCEDURE	174	"END;
"
BY_YPTJ	PROCEDURE	175	"
"
BY_YPTJ	PROCEDURE	176	"   IF V_BYKC = 0 THEN
"
BY_YPTJ	PROCEDURE	177	"      V_BYKC := ROUND(V_BYKC_FZ/V_YPBZL,2);
"
BY_YPTJ	PROCEDURE	178	"   END IF ;
"
BY_YPTJ	PROCEDURE	179	"
"
BY_YPTJ	PROCEDURE	180	"      V_TJSL := NVL(V_BYKC,0);
"
BY_YPTJ	PROCEDURE	181	"      V_LSTJJE := ROUND((V_XLSJ - V_YLSJ) * V_TJSL,2);
"
BY_YPTJ	PROCEDURE	182	"      V_LSJTJ := V_XLSJ - V_YLSJ;
"
BY_YPTJ	PROCEDURE	183	"
"
BY_YPTJ	PROCEDURE	184	"      INSERT INTO BY_TJDMX(XTXH,TJDH,XH,YPXH,YPCDDM,YPLX,TJSL,YLSJ,XLSJ,YKXTXH,YKCRKFSDM,YKCRKDH)
"
BY_YPTJ	PROCEDURE	185	"      VALUES (V_YFXTXH,V_TJDH,V_XH,V_YPXH,V_YPCDDM,V_YPLX,V_TJSL,V_YLSJ,V_XLSJ,P_XTXH,V_CRKFSDM,P_TJDH);
"
BY_YPTJ	PROCEDURE	186	"
"
BY_YPTJ	PROCEDURE	187	"      IF V_LSJTJ > 0 THEN
"
BY_YPTJ	PROCEDURE	188	"        INSERT INTO BY_YPMXZ (KSDM,CRKDM,CRKDH,XH,XTXH,YPLX,YPXH,YPCDDM,LSJ,SL,RQ,ZY)
"
BY_YPTJ	PROCEDURE	189	"        VALUES (V_KSDM,33,V_TJDH,V_XH,V_YFXTXH,V_YPLX,V_YPXH,V_YPCDDM,V_XLSJ - V_YLSJ,V_TJSL,V_ZXRQ,'调升') ;
"
BY_YPTJ	PROCEDURE	190	"      ELSE
"
BY_YPTJ	PROCEDURE	191	"        INSERT INTO BY_YPMXZ (KSDM,CRKDM,CRKDH,XH,XTXH,YPLX,YPXH,YPCDDM,LSJ,SL,RQ,ZY)
"
BY_YPTJ	PROCEDURE	192	"        VALUES (V_KSDM,83,V_TJDH,V_XH,V_YFXTXH,V_YPLX,V_YPXH,V_YPCDDM,ABS(V_XLSJ - V_YLSJ),V_TJSL,V_ZXRQ,'调降') ;
"
BY_YPTJ	PROCEDURE	193	"      END IF;
"
BY_YPTJ	PROCEDURE	194	"
"
BY_YPTJ	PROCEDURE	195	"      END IF;
"
BY_YPTJ	PROCEDURE	196	"
"
BY_YPTJ	PROCEDURE	197	"   END LOOP;
"
BY_YPTJ	PROCEDURE	198	"   CLOSE CUR_TJYP;
"
BY_YPTJ	PROCEDURE	199	"
"
BY_YPTJ	PROCEDURE	200	"   END LOOP;
"
BY_YPTJ	PROCEDURE	201	"   CLOSE CUR_YFXH;
"
BY_YPTJ	PROCEDURE	202	"
"
BY_YPTJ	PROCEDURE	203	"   UPDATE GY_XTCS SET CSZ1 = P_TJDH 
"
BY_YPTJ	PROCEDURE	204	"   WHERE XTXH=P_XTXH AND CSMC='TJDH'; 
"
BY_YPTJ	PROCEDURE	205	"          --将新生成的调价单号放入参数表中,供程序中调用
"
BY_YPTJ	PROCEDURE	206	"
"
BY_YPTJ	PROCEDURE	207	"EXCEPTION  -- exception handlers begin
"
BY_YPTJ	PROCEDURE	208	"   WHEN E_TJDHNOTFOUND THEN
"
BY_YPTJ	PROCEDURE	209	"	ROLLBACK;
"
BY_YPTJ	PROCEDURE	210	"	RAISE_APPLICATION_ERROR(-20801,
"
BY_YPTJ	PROCEDURE	211	"	'药房系统序号为'||TO_CHAR(V_YFXTXH)||'的调价单号在表BY_CRKFS中取不到或发生错误!');
"
BY_YPTJ	PROCEDURE	212	"   WHEN E_KSDMNOTFOUND THEN
"
BY_YPTJ	PROCEDURE	213	"	ROLLBACK;
"
BY_YPTJ	PROCEDURE	214	"	RAISE_APPLICATION_ERROR(-20802,
"
BY_YPTJ	PROCEDURE	215	"	'药房系统序号为'||TO_CHAR(V_YFXTXH)||'的科室代码在表BY_CKXH中取不到或发生错误!');
"
BY_YPTJ	PROCEDURE	216	"--   WHEN OTHERS THEN  -- handles all other errors
"
BY_YPTJ	PROCEDURE	217	"--        ROLLBACK;
"
BY_YPTJ	PROCEDURE	218	"--	RAISE_APPLICATION_ERROR(-20810,'病区药房调价 FAILS');
"
BY_YPTJ	PROCEDURE	219	"END;
"
BY_YPTJ	PROCEDURE	220	"END;
"
BY_YPTJ	PROCEDURE	221	"
"
BY_YPTJ	PROCEDURE	222	"
"
BY_YPTJ	PROCEDURE	223	 
