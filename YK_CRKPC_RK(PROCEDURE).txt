YK_CRKPC_RK	PROCEDURE	1	"PROCEDURE         ""YK_CRKPC_RK"" (
"
YK_CRKPC_RK	PROCEDURE	2	"        P_XTXH   IN NUMBER,
"
YK_CRKPC_RK	PROCEDURE	3	"	P_CRKFSDM IN NUMBER,
"
YK_CRKPC_RK	PROCEDURE	4	"	P_KJQJ	 IN CHAR) IS
"
YK_CRKPC_RK	PROCEDURE	5	"BEGIN
"
YK_CRKPC_RK	PROCEDURE	6	"DECLARE
"
YK_CRKPC_RK	PROCEDURE	7	"
"
YK_CRKPC_RK	PROCEDURE	8	"   V_CRKDH	CHAR(8);
"
YK_CRKPC_RK	PROCEDURE	9	"   V_DWBH	NUMBER(4);
"
YK_CRKPC_RK	PROCEDURE	10	"   V_DWMC	VARCHAR2(40);
"
YK_CRKPC_RK	PROCEDURE	11	"   V_JJJE	NUMBER(14,4);
"
YK_CRKPC_RK	PROCEDURE	12	"   V_PFJE	NUMBER(14,4);
"
YK_CRKPC_RK	PROCEDURE	13	"   V_LSJE	NUMBER(14,4);
"
YK_CRKPC_RK	PROCEDURE	14	"   V_JXCE	NUMBER(14,4);
"
YK_CRKPC_RK	PROCEDURE	15	"   V_PLCE	NUMBER(14,4);
"
YK_CRKPC_RK	PROCEDURE	16	"   V_RLCE	NUMBER(14,4);
"
YK_CRKPC_RK	PROCEDURE	17	"   V_JZRQ	DATE;
"
YK_CRKPC_RK	PROCEDURE	18	"   V_YFKPB	NUMBER(1);
"
YK_CRKPC_RK	PROCEDURE	19	"   V_FPHM	NUMBER(3);
"
YK_CRKPC_RK	PROCEDURE	20	"   V_JSDH	NUMBER;
"
YK_CRKPC_RK	PROCEDURE	21	"   V_FKRQ	DATE;
"
YK_CRKPC_RK	PROCEDURE	22	"   V_YFKBZ	NUMBER(1);
"
YK_CRKPC_RK	PROCEDURE	23	"   V_QTPB	NUMBER(1);
"
YK_CRKPC_RK	PROCEDURE	24	"   V_COUNT1	NUMBER;
"
YK_CRKPC_RK	PROCEDURE	25	"   V_COUNT2	NUMBER;
"
YK_CRKPC_RK	PROCEDURE	26	"   V_JJHS	NUMBER(1);
"
YK_CRKPC_RK	PROCEDURE	27	"
"
YK_CRKPC_RK	PROCEDURE	28	"   CURSOR CUR_RKD IS
"
YK_CRKPC_RK	PROCEDURE	29	"    SELECT RKDH,JZRQ,GHDWBH,JSDH,FKRQ,YFKBZ
"
YK_CRKPC_RK	PROCEDURE	30	"    FROM YK_YPRKD
"
YK_CRKPC_RK	PROCEDURE	31	"    WHERE XTXH = P_XTXH AND CRKFSDM = P_CRKFSDM AND
"
YK_CRKPC_RK	PROCEDURE	32	"          RKDH LIKE P_KJQJ||'%' AND YDZBZ = 1
"
YK_CRKPC_RK	PROCEDURE	33	"          ORDER BY RKDH;
"
YK_CRKPC_RK	PROCEDURE	34	"
"
YK_CRKPC_RK	PROCEDURE	35	"   CURSOR CUR_DJJE IS
"
YK_CRKPC_RK	PROCEDURE	36	"    SELECT NVL(SUM(ROUND(NVL(JJ,0) *RKSL,2)),0),
"
YK_CRKPC_RK	PROCEDURE	37	"           NVL(SUM(ROUND(NVL(PFJ,0)*RKSL,2)),0),
"
YK_CRKPC_RK	PROCEDURE	38	"           NVL(SUM(ROUND(NVL(LSJ,0)*RKSL,2)),0)
"
YK_CRKPC_RK	PROCEDURE	39	"    FROM YK_YPRKDMX
"
YK_CRKPC_RK	PROCEDURE	40	"    WHERE XTXH = P_XTXH AND CRKFSDM = P_CRKFSDM AND RKDH = V_CRKDH
"
YK_CRKPC_RK	PROCEDURE	41	"    GROUP BY XTXH,CRKFSDM,RKDH;
"
YK_CRKPC_RK	PROCEDURE	42	"
"
YK_CRKPC_RK	PROCEDURE	43	"BEGIN
"
YK_CRKPC_RK	PROCEDURE	44	"
"
YK_CRKPC_RK	PROCEDURE	45	"---- INIT
"
YK_CRKPC_RK	PROCEDURE	46	"  DELETE FROM YK_CRKPC_T WHERE XTXH =P_XTXH AND CRKFSDM = P_CRKFSDM;
"
YK_CRKPC_RK	PROCEDURE	47	"
"
YK_CRKPC_RK	PROCEDURE	48	"---- START
"
YK_CRKPC_RK	PROCEDURE	49	"  OPEN CUR_RKD;
"
YK_CRKPC_RK	PROCEDURE	50	"  LOOP
"
YK_CRKPC_RK	PROCEDURE	51	"       FETCH CUR_RKD INTO V_CRKDH,V_JZRQ,V_DWBH,V_JSDH,V_FKRQ,V_YFKBZ;
"
YK_CRKPC_RK	PROCEDURE	52	"       EXIT WHEN CUR_RKD%NOTFOUND;
"
YK_CRKPC_RK	PROCEDURE	53	"
"
YK_CRKPC_RK	PROCEDURE	54	"-- JJHS
"
YK_CRKPC_RK	PROCEDURE	55	"       BEGIN
"
YK_CRKPC_RK	PROCEDURE	56	"        SELECT JJHS INTO V_JJHS
"
YK_CRKPC_RK	PROCEDURE	57	"        FROM YK_CRKFS
"
YK_CRKPC_RK	PROCEDURE	58	"        WHERE XTXH = P_XTXH AND CRKFX = 1 AND CRKFSDM = P_CRKFSDM;
"
YK_CRKPC_RK	PROCEDURE	59	"        EXCEPTION      
"
YK_CRKPC_RK	PROCEDURE	60	"	    WHEN NO_DATA_FOUND THEN
"
YK_CRKPC_RK	PROCEDURE	61	"            V_JJHS := 1;
"
YK_CRKPC_RK	PROCEDURE	62	"       END;
"
YK_CRKPC_RK	PROCEDURE	63	"
"
YK_CRKPC_RK	PROCEDURE	64	"-- DWMC    
"
YK_CRKPC_RK	PROCEDURE	65	"       BEGIN
"
YK_CRKPC_RK	PROCEDURE	66	"        SELECT DWMC,NVL(YFKPB,0) INTO V_DWMC,V_YFKPB
"
YK_CRKPC_RK	PROCEDURE	67	"        FROM YK_JHDW
"
YK_CRKPC_RK	PROCEDURE	68	"        WHERE XTXH = P_XTXH AND DWBH = V_DWBH;
"
YK_CRKPC_RK	PROCEDURE	69	"        EXCEPTION      
"
YK_CRKPC_RK	PROCEDURE	70	"	    WHEN NO_DATA_FOUND THEN
"
YK_CRKPC_RK	PROCEDURE	71	"            V_DWMC := '错误';
"
YK_CRKPC_RK	PROCEDURE	72	"            V_YFKPB := 0;
"
YK_CRKPC_RK	PROCEDURE	73	"       END;
"
YK_CRKPC_RK	PROCEDURE	74	"
"
YK_CRKPC_RK	PROCEDURE	75	"-- QTPB     
"
YK_CRKPC_RK	PROCEDURE	76	"       BEGIN
"
YK_CRKPC_RK	PROCEDURE	77	"        SELECT NVL(QTPB,0) INTO V_QTPB
"
YK_CRKPC_RK	PROCEDURE	78	"        FROM YK_CRKFS
"
YK_CRKPC_RK	PROCEDURE	79	"        WHERE XTXH = P_XTXH AND CRKFSDM = P_CRKFSDM;
"
YK_CRKPC_RK	PROCEDURE	80	"        EXCEPTION      
"
YK_CRKPC_RK	PROCEDURE	81	"	    WHEN NO_DATA_FOUND THEN
"
YK_CRKPC_RK	PROCEDURE	82	"            V_QTPB := 0;
"
YK_CRKPC_RK	PROCEDURE	83	"       END;
"
YK_CRKPC_RK	PROCEDURE	84	"
"
YK_CRKPC_RK	PROCEDURE	85	"--应付款判别
"
YK_CRKPC_RK	PROCEDURE	86	"      IF V_QTPB = 1 AND V_YFKPB = 1 THEN
"
YK_CRKPC_RK	PROCEDURE	87	"         V_YFKPB := 1;
"
YK_CRKPC_RK	PROCEDURE	88	"      ELSE
"
YK_CRKPC_RK	PROCEDURE	89	"         V_YFKPB := 0;
"
YK_CRKPC_RK	PROCEDURE	90	"      END IF;
"
YK_CRKPC_RK	PROCEDURE	91	"
"
YK_CRKPC_RK	PROCEDURE	92	"-- 发票
"
YK_CRKPC_RK	PROCEDURE	93	"      BEGIN
"
YK_CRKPC_RK	PROCEDURE	94	"       SELECT COUNT(*)  INTO V_COUNT1
"
YK_CRKPC_RK	PROCEDURE	95	"       FROM YK_YPRKDMX 
"
YK_CRKPC_RK	PROCEDURE	96	"       WHERE XTXH = P_XTXH AND RKDH = V_CRKDH AND CRKFSDM = P_CRKFSDM ;
"
YK_CRKPC_RK	PROCEDURE	97	"       EXCEPTION      
"
YK_CRKPC_RK	PROCEDURE	98	"	   WHEN NO_DATA_FOUND THEN
"
YK_CRKPC_RK	PROCEDURE	99	"           V_COUNT1 := -1;
"
YK_CRKPC_RK	PROCEDURE	100	"      END;
"
YK_CRKPC_RK	PROCEDURE	101	"
"
YK_CRKPC_RK	PROCEDURE	102	"      BEGIN
"
YK_CRKPC_RK	PROCEDURE	103	"       SELECT COUNT(*)  INTO V_COUNT2
"
YK_CRKPC_RK	PROCEDURE	104	"       FROM YK_YPRKDMX 
"
YK_CRKPC_RK	PROCEDURE	105	"       WHERE XTXH = P_XTXH AND RKDH = V_CRKDH AND CRKFSDM = P_CRKFSDM  
"
YK_CRKPC_RK	PROCEDURE	106	"       AND FPHM IS NOT NULL AND LENGTH(LTRIM(RTRIM(FPHM))) <> 0;
"
YK_CRKPC_RK	PROCEDURE	107	"       EXCEPTION      
"
YK_CRKPC_RK	PROCEDURE	108	"	   WHEN NO_DATA_FOUND THEN
"
YK_CRKPC_RK	PROCEDURE	109	"           V_COUNT2 := -1;
"
YK_CRKPC_RK	PROCEDURE	110	"      END;
"
YK_CRKPC_RK	PROCEDURE	111	"
"
YK_CRKPC_RK	PROCEDURE	112	"-- 2 已到 ; 1 部分到 ; 0 未到 ; -1 错误 ;3 无 (如赠品入库)
"
YK_CRKPC_RK	PROCEDURE	113	"      
"
YK_CRKPC_RK	PROCEDURE	114	"      IF V_COUNT2 > 0 THEN
"
YK_CRKPC_RK	PROCEDURE	115	"         IF V_COUNT2 = V_COUNT1 THEN
"
YK_CRKPC_RK	PROCEDURE	116	"            V_FPHM := 2;
"
YK_CRKPC_RK	PROCEDURE	117	"         ELSE
"
YK_CRKPC_RK	PROCEDURE	118	"            V_FPHM := 1;
"
YK_CRKPC_RK	PROCEDURE	119	"         END IF;
"
YK_CRKPC_RK	PROCEDURE	120	"      ELSIF V_COUNT2 = 0 THEN
"
YK_CRKPC_RK	PROCEDURE	121	"         V_FPHM := 0;
"
YK_CRKPC_RK	PROCEDURE	122	"      ELSE
"
YK_CRKPC_RK	PROCEDURE	123	"         V_FPHM := -1;
"
YK_CRKPC_RK	PROCEDURE	124	"      END IF;
"
YK_CRKPC_RK	PROCEDURE	125	"
"
YK_CRKPC_RK	PROCEDURE	126	"-- START CUR_DJJE    
"
YK_CRKPC_RK	PROCEDURE	127	"  OPEN CUR_DJJE;
"
YK_CRKPC_RK	PROCEDURE	128	"  LOOP
"
YK_CRKPC_RK	PROCEDURE	129	"       FETCH CUR_DJJE INTO V_JJJE,V_PFJE,V_LSJE;
"
YK_CRKPC_RK	PROCEDURE	130	"       EXIT WHEN CUR_DJJE%NOTFOUND;
"
YK_CRKPC_RK	PROCEDURE	131	"
"
YK_CRKPC_RK	PROCEDURE	132	"      IF V_JJHS = 0 THEN
"
YK_CRKPC_RK	PROCEDURE	133	"         V_FPHM := 3;
"
YK_CRKPC_RK	PROCEDURE	134	"	 V_JXCE := V_LSJE - V_PFJE;
"
YK_CRKPC_RK	PROCEDURE	135	"         V_PLCE := V_LSJE - V_PFJE;
"
YK_CRKPC_RK	PROCEDURE	136	"         V_RLCE := 0;
"
YK_CRKPC_RK	PROCEDURE	137	"      ELSE
"
YK_CRKPC_RK	PROCEDURE	138	"	 V_JXCE := V_LSJE - V_JJJE;
"
YK_CRKPC_RK	PROCEDURE	139	"         V_PLCE := V_LSJE - V_PFJE;
"
YK_CRKPC_RK	PROCEDURE	140	"         V_RLCE := V_PFJE - V_JJJE;
"
YK_CRKPC_RK	PROCEDURE	141	"      END IF;
"
YK_CRKPC_RK	PROCEDURE	142	"
"
YK_CRKPC_RK	PROCEDURE	143	"INSERT INTO YK_CRKPC_T
"
YK_CRKPC_RK	PROCEDURE	144	"(XTXH,CRKFSDM,CRKDH,DWBH,DWMC,JJJE,PFJE,LSJE,JXCE,PLCE,RLCE,
"
YK_CRKPC_RK	PROCEDURE	145	"JZRQ,YFKPB,FPHM,JSDH,FKRQ,YFKBZ)
"
YK_CRKPC_RK	PROCEDURE	146	"VALUES
"
YK_CRKPC_RK	PROCEDURE	147	"(P_XTXH,P_CRKFSDM,V_CRKDH,V_DWBH,V_DWMC,V_JJJE,V_PFJE,V_LSJE,V_JXCE,V_PLCE,V_RLCE,
"
YK_CRKPC_RK	PROCEDURE	148	"V_JZRQ,V_YFKPB,V_FPHM,V_JSDH,V_FKRQ,V_YFKBZ);
"
YK_CRKPC_RK	PROCEDURE	149	"
"
YK_CRKPC_RK	PROCEDURE	150	"   END LOOP;
"
YK_CRKPC_RK	PROCEDURE	151	"   CLOSE CUR_DJJE;
"
YK_CRKPC_RK	PROCEDURE	152	"-- END CUR_DJJE
"
YK_CRKPC_RK	PROCEDURE	153	"
"
YK_CRKPC_RK	PROCEDURE	154	"   END LOOP;
"
YK_CRKPC_RK	PROCEDURE	155	"   CLOSE CUR_RKD;
"
YK_CRKPC_RK	PROCEDURE	156	"
"
YK_CRKPC_RK	PROCEDURE	157	"EXCEPTION  -- exception handlers begin
"
YK_CRKPC_RK	PROCEDURE	158	"   WHEN OTHERS THEN  -- handles all other errors
"
YK_CRKPC_RK	PROCEDURE	159	"        ROLLBACK;
"
YK_CRKPC_RK	PROCEDURE	160	"	RAISE_APPLICATION_ERROR(-20103,'出入库批次--入库程序执行失败!');
"
YK_CRKPC_RK	PROCEDURE	161	"END;
"
YK_CRKPC_RK	PROCEDURE	162	"END;
"
YK_CRKPC_RK	PROCEDURE	163	"
"
YK_CRKPC_RK	PROCEDURE	164	"
"
YK_CRKPC_RK	PROCEDURE	165	"
"
YK_CRKPC_RK	PROCEDURE	166	 
