YK_LDZC_YP	PROCEDURE	1	"PROCEDURE         ""YK_LDZC_YP"" (
"
YK_LDZC_YP	PROCEDURE	2	"        P_XTXH   IN NUMBER,
"
YK_LDZC_YP	PROCEDURE	3	"	P_YPXH   IN NUMBER,
"
YK_LDZC_YP	PROCEDURE	4	"	P_YPCDDM IN NUMBER ) IS
"
YK_LDZC_YP	PROCEDURE	5	"BEGIN
"
YK_LDZC_YP	PROCEDURE	6	"DECLARE
"
YK_LDZC_YP	PROCEDURE	7	"
"
YK_LDZC_YP	PROCEDURE	8	"   V_RKDH	CHAR(8);
"
YK_LDZC_YP	PROCEDURE	9	"   V_CRKFSDM    NUMBER(2);
"
YK_LDZC_YP	PROCEDURE	10	"   V_JJ		NUMBER(16,6);
"
YK_LDZC_YP	PROCEDURE	11	"   V_PFJ	NUMBER(16,6);
"
YK_LDZC_YP	PROCEDURE	12	"   V_LSJ	NUMBER(16,6);
"
YK_LDZC_YP	PROCEDURE	13	"   V_ZBLB	NUMBER(2);
"
YK_LDZC_YP	PROCEDURE	14	"   V_RKRQ	DATE;
"
YK_LDZC_YP	PROCEDURE	15	"   V_JZRQ	DATE;
"
YK_LDZC_YP	PROCEDURE	16	"   V_FKRQ	DATE;
"
YK_LDZC_YP	PROCEDURE	17	"   V_DWMC	VARCHAR2(40);
"
YK_LDZC_YP	PROCEDURE	18	"   V_XH		NUMBER(4);
"
YK_LDZC_YP	PROCEDURE	19	"   V_DWBH	NUMBER(4);
"
YK_LDZC_YP	PROCEDURE	20	"   V_JSDH	NUMBER(8);
"
YK_LDZC_YP	PROCEDURE	21	"   V_YDZBZ	NUMBER(1);
"
YK_LDZC_YP	PROCEDURE	22	"   V_YFKBZ	NUMBER(1);
"
YK_LDZC_YP	PROCEDURE	23	"   V_JJJE	NUMBER(14,4);
"
YK_LDZC_YP	PROCEDURE	24	"   V_PFJE	NUMBER(14,4);
"
YK_LDZC_YP	PROCEDURE	25	"   V_LSJE	NUMBER(14,4);
"
YK_LDZC_YP	PROCEDURE	26	"   V_JXCE	NUMBER(14,4);
"
YK_LDZC_YP	PROCEDURE	27	"   V_PLCE	NUMBER(14,4);
"
YK_LDZC_YP	PROCEDURE	28	"   V_RLCE	NUMBER(14,4);
"
YK_LDZC_YP	PROCEDURE	29	"   V_COUNT1	NUMBER;
"
YK_LDZC_YP	PROCEDURE	30	"   V_COUNT2	NUMBER;
"
YK_LDZC_YP	PROCEDURE	31	"   V_FPHM	NUMBER(3);
"
YK_LDZC_YP	PROCEDURE	32	"   V_RKDH_OLD   CHAR(8);
"
YK_LDZC_YP	PROCEDURE	33	"   V_CRKFSDM_OLD NUMBER(2);
"
YK_LDZC_YP	PROCEDURE	34	"   V_YFKPB	NUMBER(1);
"
YK_LDZC_YP	PROCEDURE	35	"   V_QTPB	NUMBER(1);
"
YK_LDZC_YP	PROCEDURE	36	"   V_JJHS	NUMBER(1);
"
YK_LDZC_YP	PROCEDURE	37	"
"
YK_LDZC_YP	PROCEDURE	38	"   CURSOR CUR_LDZC IS 
"
YK_LDZC_YP	PROCEDURE	39	"    SELECT RKDH,CRKFSDM,JJ,PFJ,LSJ,ZBLB,XH
"
YK_LDZC_YP	PROCEDURE	40	"    FROM YK_YPRKDMX WHERE XTXH = P_XTXH AND YPXH = P_YPXH AND YPCDDM = P_YPCDDM ORDER BY RKDH;
"
YK_LDZC_YP	PROCEDURE	41	"
"
YK_LDZC_YP	PROCEDURE	42	"BEGIN
"
YK_LDZC_YP	PROCEDURE	43	"
"
YK_LDZC_YP	PROCEDURE	44	"---- INIT
"
YK_LDZC_YP	PROCEDURE	45	"--     DELETE FROM YK_LDZC_TEMP WHERE XTXH = P_XTXH AND YPXH = P_YPXH AND YPCDDM = P_YPCDDM ;
"
YK_LDZC_YP	PROCEDURE	46	"     DELETE FROM YK_LDZC_TEMP WHERE XTXH = P_XTXH;
"
YK_LDZC_YP	PROCEDURE	47	"
"
YK_LDZC_YP	PROCEDURE	48	"---- START
"
YK_LDZC_YP	PROCEDURE	49	"
"
YK_LDZC_YP	PROCEDURE	50	"  V_RKDH_OLD := '';
"
YK_LDZC_YP	PROCEDURE	51	"  V_CRKFSDM_OLD := 0;
"
YK_LDZC_YP	PROCEDURE	52	"
"
YK_LDZC_YP	PROCEDURE	53	"  OPEN CUR_LDZC;
"
YK_LDZC_YP	PROCEDURE	54	"  LOOP
"
YK_LDZC_YP	PROCEDURE	55	"       FETCH CUR_LDZC INTO V_RKDH,V_CRKFSDM,V_JJ,V_PFJ,V_LSJ,V_ZBLB,V_XH;
"
YK_LDZC_YP	PROCEDURE	56	"       EXIT WHEN CUR_LDZC%NOTFOUND;
"
YK_LDZC_YP	PROCEDURE	57	"    
"
YK_LDZC_YP	PROCEDURE	58	"       IF (V_RKDH <> V_RKDH_OLD) OR (V_CRKFSDM <> V_CRKFSDM_OLD) THEN
"
YK_LDZC_YP	PROCEDURE	59	"          V_RKDH_OLD := V_RKDH;
"
YK_LDZC_YP	PROCEDURE	60	"          V_CRKFSDM_OLD := V_CRKFSDM;
"
YK_LDZC_YP	PROCEDURE	61	"
"
YK_LDZC_YP	PROCEDURE	62	"      BEGIN     
"
YK_LDZC_YP	PROCEDURE	63	"       SELECT RKRQ,JZRQ,FKRQ,GHDWBH,JSDH,YDZBZ,YFKBZ
"
YK_LDZC_YP	PROCEDURE	64	"       INTO V_RKRQ,V_JZRQ,V_FKRQ,V_DWBH,V_JSDH,V_YDZBZ,V_YFKBZ
"
YK_LDZC_YP	PROCEDURE	65	"       FROM YK_YPRKD
"
YK_LDZC_YP	PROCEDURE	66	"       WHERE XTXH = P_XTXH AND RKDH = V_RKDH AND CRKFSDM = V_CRKFSDM;
"
YK_LDZC_YP	PROCEDURE	67	"       EXCEPTION      
"
YK_LDZC_YP	PROCEDURE	68	"	   WHEN NO_DATA_FOUND THEN
"
YK_LDZC_YP	PROCEDURE	69	"           V_DWBH := 0;
"
YK_LDZC_YP	PROCEDURE	70	"      END;
"
YK_LDZC_YP	PROCEDURE	71	"
"
YK_LDZC_YP	PROCEDURE	72	"-- JJHS
"
YK_LDZC_YP	PROCEDURE	73	"       BEGIN
"
YK_LDZC_YP	PROCEDURE	74	"        SELECT JJHS INTO V_JJHS
"
YK_LDZC_YP	PROCEDURE	75	"        FROM YK_CRKFS
"
YK_LDZC_YP	PROCEDURE	76	"        WHERE XTXH = P_XTXH AND KCFX = 1 AND CRKFSDM = V_CRKFSDM;
"
YK_LDZC_YP	PROCEDURE	77	"        EXCEPTION      
"
YK_LDZC_YP	PROCEDURE	78	"	    WHEN NO_DATA_FOUND THEN
"
YK_LDZC_YP	PROCEDURE	79	"            V_JJHS := 1;
"
YK_LDZC_YP	PROCEDURE	80	"       END;
"
YK_LDZC_YP	PROCEDURE	81	"
"
YK_LDZC_YP	PROCEDURE	82	"-- DWMC
"
YK_LDZC_YP	PROCEDURE	83	"      BEGIN
"
YK_LDZC_YP	PROCEDURE	84	"       SELECT DWMC,NVL(YFKPB,0) INTO V_DWMC,V_YFKPB
"
YK_LDZC_YP	PROCEDURE	85	"       FROM YK_JHDW
"
YK_LDZC_YP	PROCEDURE	86	"       WHERE XTXH = P_XTXH AND DWBH = V_DWBH;
"
YK_LDZC_YP	PROCEDURE	87	"       EXCEPTION      
"
YK_LDZC_YP	PROCEDURE	88	"	   WHEN NO_DATA_FOUND THEN
"
YK_LDZC_YP	PROCEDURE	89	"           V_DWMC := '错误';
"
YK_LDZC_YP	PROCEDURE	90	"           V_YFKPB := 0;
"
YK_LDZC_YP	PROCEDURE	91	"      END;
"
YK_LDZC_YP	PROCEDURE	92	" 
"
YK_LDZC_YP	PROCEDURE	93	"      BEGIN
"
YK_LDZC_YP	PROCEDURE	94	"       SELECT NVL(QTPB,0) INTO V_QTPB
"
YK_LDZC_YP	PROCEDURE	95	"       FROM YK_CRKFS
"
YK_LDZC_YP	PROCEDURE	96	"       WHERE XTXH = P_XTXH AND CRKFSDM = V_CRKFSDM;
"
YK_LDZC_YP	PROCEDURE	97	"       EXCEPTION      
"
YK_LDZC_YP	PROCEDURE	98	"	    WHEN NO_DATA_FOUND THEN
"
YK_LDZC_YP	PROCEDURE	99	"           V_QTPB := 0;
"
YK_LDZC_YP	PROCEDURE	100	"      END;
"
YK_LDZC_YP	PROCEDURE	101	"
"
YK_LDZC_YP	PROCEDURE	102	"--应付款判别
"
YK_LDZC_YP	PROCEDURE	103	"      IF V_QTPB = 1 AND V_YFKPB = 1 THEN
"
YK_LDZC_YP	PROCEDURE	104	"         V_YFKPB := 1;
"
YK_LDZC_YP	PROCEDURE	105	"      ELSE
"
YK_LDZC_YP	PROCEDURE	106	"         V_YFKPB := 0;
"
YK_LDZC_YP	PROCEDURE	107	"      END IF;
"
YK_LDZC_YP	PROCEDURE	108	"--
"
YK_LDZC_YP	PROCEDURE	109	"
"
YK_LDZC_YP	PROCEDURE	110	"      BEGIN
"
YK_LDZC_YP	PROCEDURE	111	"       SELECT SUM(ROUND(NVL(JJ,0)*RKSL,2)),SUM(ROUND(NVL(PFJ,0)*RKSL,2)),
"
YK_LDZC_YP	PROCEDURE	112	"              SUM(ROUND(NVL(LSJ,0)*RKSL,2))
"
YK_LDZC_YP	PROCEDURE	113	"       INTO V_JJJE,V_PFJE,V_LSJE
"
YK_LDZC_YP	PROCEDURE	114	"       FROM YK_YPRKDMX 
"
YK_LDZC_YP	PROCEDURE	115	"       WHERE XTXH = P_XTXH AND RKDH = V_RKDH AND CRKFSDM = V_CRKFSDM;
"
YK_LDZC_YP	PROCEDURE	116	"       EXCEPTION      
"
YK_LDZC_YP	PROCEDURE	117	"	   WHEN NO_DATA_FOUND THEN
"
YK_LDZC_YP	PROCEDURE	118	"           V_JJJE := 0;
"
YK_LDZC_YP	PROCEDURE	119	"           V_PFJE := 0;
"
YK_LDZC_YP	PROCEDURE	120	"           V_LSJE := 0;
"
YK_LDZC_YP	PROCEDURE	121	"      END;
"
YK_LDZC_YP	PROCEDURE	122	"
"
YK_LDZC_YP	PROCEDURE	123	"-- 发票
"
YK_LDZC_YP	PROCEDURE	124	"
"
YK_LDZC_YP	PROCEDURE	125	"      BEGIN
"
YK_LDZC_YP	PROCEDURE	126	"       SELECT COUNT(*)  INTO V_COUNT1
"
YK_LDZC_YP	PROCEDURE	127	"       FROM YK_YPRKDMX 
"
YK_LDZC_YP	PROCEDURE	128	"       WHERE XTXH = P_XTXH AND RKDH = V_RKDH AND CRKFSDM = V_CRKFSDM ;
"
YK_LDZC_YP	PROCEDURE	129	"       EXCEPTION      
"
YK_LDZC_YP	PROCEDURE	130	"	   WHEN NO_DATA_FOUND THEN
"
YK_LDZC_YP	PROCEDURE	131	"           V_COUNT1 := -1;
"
YK_LDZC_YP	PROCEDURE	132	"      END;
"
YK_LDZC_YP	PROCEDURE	133	"
"
YK_LDZC_YP	PROCEDURE	134	"      BEGIN
"
YK_LDZC_YP	PROCEDURE	135	"       SELECT COUNT(*)  INTO V_COUNT2
"
YK_LDZC_YP	PROCEDURE	136	"       FROM YK_YPRKDMX 
"
YK_LDZC_YP	PROCEDURE	137	"       WHERE XTXH = P_XTXH AND RKDH = V_RKDH AND CRKFSDM = V_CRKFSDM  
"
YK_LDZC_YP	PROCEDURE	138	"       AND FPHM IS NOT NULL AND LENGTH(LTRIM(RTRIM(FPHM))) <> 0;
"
YK_LDZC_YP	PROCEDURE	139	"       EXCEPTION      
"
YK_LDZC_YP	PROCEDURE	140	"	   WHEN NO_DATA_FOUND THEN
"
YK_LDZC_YP	PROCEDURE	141	"           V_COUNT2 := -1;
"
YK_LDZC_YP	PROCEDURE	142	"      END;
"
YK_LDZC_YP	PROCEDURE	143	"
"
YK_LDZC_YP	PROCEDURE	144	"-- 2 已到 ; 1 部分到 ; 0 未到 ; -1 错误 ;3 无 (如赠品入库)
"
YK_LDZC_YP	PROCEDURE	145	"      
"
YK_LDZC_YP	PROCEDURE	146	"      IF V_COUNT2 > 0 THEN
"
YK_LDZC_YP	PROCEDURE	147	"         IF V_COUNT2 = V_COUNT1 THEN
"
YK_LDZC_YP	PROCEDURE	148	"            V_FPHM := 2;
"
YK_LDZC_YP	PROCEDURE	149	"         ELSE
"
YK_LDZC_YP	PROCEDURE	150	"            V_FPHM := 1;
"
YK_LDZC_YP	PROCEDURE	151	"         END IF;
"
YK_LDZC_YP	PROCEDURE	152	"      ELSIF V_COUNT2 = 0 THEN
"
YK_LDZC_YP	PROCEDURE	153	"         V_FPHM := 0;
"
YK_LDZC_YP	PROCEDURE	154	"      ELSE
"
YK_LDZC_YP	PROCEDURE	155	"         V_FPHM := -1;
"
YK_LDZC_YP	PROCEDURE	156	"      END IF;
"
YK_LDZC_YP	PROCEDURE	157	"
"
YK_LDZC_YP	PROCEDURE	158	"      IF V_JJHS = 0 THEN
"
YK_LDZC_YP	PROCEDURE	159	"         V_FPHM := 3;
"
YK_LDZC_YP	PROCEDURE	160	"	 V_JXCE := V_LSJE - V_PFJE;
"
YK_LDZC_YP	PROCEDURE	161	"         V_PLCE := V_LSJE - V_PFJE;
"
YK_LDZC_YP	PROCEDURE	162	"         V_RLCE := 0;
"
YK_LDZC_YP	PROCEDURE	163	"      ELSE
"
YK_LDZC_YP	PROCEDURE	164	"	 V_JXCE := V_LSJE - V_JJJE;
"
YK_LDZC_YP	PROCEDURE	165	"         V_PLCE := V_LSJE - V_PFJE;
"
YK_LDZC_YP	PROCEDURE	166	"         V_RLCE := V_PFJE - V_JJJE;
"
YK_LDZC_YP	PROCEDURE	167	"      END IF;
"
YK_LDZC_YP	PROCEDURE	168	"
"
YK_LDZC_YP	PROCEDURE	169	"      INSERT INTO YK_LDZC_TEMP 	
"
YK_LDZC_YP	PROCEDURE	170	"(XTXH,YPXH,YPCDDM,RKDH,CRKFSDM,XH,DWBH,DWMC,JJ,PFJ,LSJ,ZBLB,
"
YK_LDZC_YP	PROCEDURE	171	"JJJE,PFJE,LSJE,RKRQ,JZRQ,FKRQ,JSDH,YDZBZ,YFKBZ,FPHM,YFKPB,PLCE,JXCE,RLCE)
"
YK_LDZC_YP	PROCEDURE	172	"VALUES
"
YK_LDZC_YP	PROCEDURE	173	"(P_XTXH,P_YPXH,P_YPCDDM,V_RKDH,V_CRKFSDM,V_XH,V_DWBH,V_DWMC,V_JJ,V_PFJ,V_LSJ,V_ZBLB,
"
YK_LDZC_YP	PROCEDURE	174	"V_JJJE,V_PFJE,V_LSJE,V_RKRQ,V_JZRQ,V_FKRQ,V_JSDH,V_YDZBZ,V_YFKBZ,V_FPHM,V_YFKPB,V_PLCE,V_JXCE,V_RLCE);
"
YK_LDZC_YP	PROCEDURE	175	"
"
YK_LDZC_YP	PROCEDURE	176	"	END IF;
"
YK_LDZC_YP	PROCEDURE	177	"   END LOOP;
"
YK_LDZC_YP	PROCEDURE	178	"   CLOSE CUR_LDZC;
"
YK_LDZC_YP	PROCEDURE	179	"
"
YK_LDZC_YP	PROCEDURE	180	"--COMMIT;
"
YK_LDZC_YP	PROCEDURE	181	"
"
YK_LDZC_YP	PROCEDURE	182	"EXCEPTION  -- exception handlers begin
"
YK_LDZC_YP	PROCEDURE	183	"   WHEN OTHERS THEN  -- handles all other errors
"
YK_LDZC_YP	PROCEDURE	184	"        ROLLBACK;
"
YK_LDZC_YP	PROCEDURE	185	"	RAISE_APPLICATION_ERROR(-20103,'YK_LDZC_YP FAILS');
"
YK_LDZC_YP	PROCEDURE	186	"
"
YK_LDZC_YP	PROCEDURE	187	"END;
"
YK_LDZC_YP	PROCEDURE	188	"END;
"
YK_LDZC_YP	PROCEDURE	189	"
"
YK_LDZC_YP	PROCEDURE	190	"
"
YK_LDZC_YP	PROCEDURE	191	"
"
YK_LDZC_YP	PROCEDURE	192	 
