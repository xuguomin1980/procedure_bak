YK_LDZC_GHDW	PROCEDURE	1	"PROCEDURE         ""YK_LDZC_GHDW"" (
"
YK_LDZC_GHDW	PROCEDURE	2	"        P_XTXH   IN NUMBER,
"
YK_LDZC_GHDW	PROCEDURE	3	"        P_DWBH	 IN NUMBER ) IS
"
YK_LDZC_GHDW	PROCEDURE	4	"BEGIN
"
YK_LDZC_GHDW	PROCEDURE	5	"DECLARE
"
YK_LDZC_GHDW	PROCEDURE	6	"
"
YK_LDZC_GHDW	PROCEDURE	7	"   V_RKDH	CHAR(8);
"
YK_LDZC_GHDW	PROCEDURE	8	"   V_CRKFSDM    NUMBER(2);
"
YK_LDZC_GHDW	PROCEDURE	9	"   V_JJ		NUMBER(16,6);
"
YK_LDZC_GHDW	PROCEDURE	10	"   V_PFJ	NUMBER(16,6);
"
YK_LDZC_GHDW	PROCEDURE	11	"   V_LSJ	NUMBER(16,6);
"
YK_LDZC_GHDW	PROCEDURE	12	"   V_ZBLB	NUMBER(2);
"
YK_LDZC_GHDW	PROCEDURE	13	"   V_RKRQ	DATE;
"
YK_LDZC_GHDW	PROCEDURE	14	"   V_JZRQ	DATE;
"
YK_LDZC_GHDW	PROCEDURE	15	"   V_FKRQ	DATE;
"
YK_LDZC_GHDW	PROCEDURE	16	"   V_DWMC	VARCHAR2(40);
"
YK_LDZC_GHDW	PROCEDURE	17	"   V_XH		NUMBER(4);
"
YK_LDZC_GHDW	PROCEDURE	18	"   V_DWBH	NUMBER(4);
"
YK_LDZC_GHDW	PROCEDURE	19	"   V_JSDH	NUMBER(8);
"
YK_LDZC_GHDW	PROCEDURE	20	"   V_YDZBZ	NUMBER(1);
"
YK_LDZC_GHDW	PROCEDURE	21	"   V_YFKBZ	NUMBER(1);
"
YK_LDZC_GHDW	PROCEDURE	22	"   V_JJJE	NUMBER(14,4);
"
YK_LDZC_GHDW	PROCEDURE	23	"   V_PFJE	NUMBER(14,4);
"
YK_LDZC_GHDW	PROCEDURE	24	"   V_LSJE	NUMBER(14,4);
"
YK_LDZC_GHDW	PROCEDURE	25	"   V_JXCE	NUMBER(14,4);
"
YK_LDZC_GHDW	PROCEDURE	26	"   V_PLCE	NUMBER(14,4);
"
YK_LDZC_GHDW	PROCEDURE	27	"   V_RLCE	NUMBER(14,4);
"
YK_LDZC_GHDW	PROCEDURE	28	"   V_COUNT1	NUMBER;
"
YK_LDZC_GHDW	PROCEDURE	29	"   V_COUNT2	NUMBER;
"
YK_LDZC_GHDW	PROCEDURE	30	"   V_FPHM	NUMBER(3);
"
YK_LDZC_GHDW	PROCEDURE	31	"   V_YFKPB	NUMBER(1);
"
YK_LDZC_GHDW	PROCEDURE	32	"   V_QTPB	NUMBER(1);
"
YK_LDZC_GHDW	PROCEDURE	33	"   V_JJHS	NUMBER(1);
"
YK_LDZC_GHDW	PROCEDURE	34	"
"
YK_LDZC_GHDW	PROCEDURE	35	"   CURSOR CUR_LDZC_GHDW IS 
"
YK_LDZC_GHDW	PROCEDURE	36	"    SELECT RKDH,CRKFSDM,RKRQ,JZRQ,FKRQ,JSDH,YDZBZ,YFKBZ
"
YK_LDZC_GHDW	PROCEDURE	37	"    FROM YK_YPRKD WHERE XTXH = P_XTXH AND GHDWBH = P_DWBH;
"
YK_LDZC_GHDW	PROCEDURE	38	"
"
YK_LDZC_GHDW	PROCEDURE	39	"BEGIN
"
YK_LDZC_GHDW	PROCEDURE	40	"
"
YK_LDZC_GHDW	PROCEDURE	41	"---- INIT
"
YK_LDZC_GHDW	PROCEDURE	42	"--     DELETE FROM YK_LDZC_TEMP WHERE XTXH = P_XTXH AND DWBH = P_DWBH;
"
YK_LDZC_GHDW	PROCEDURE	43	"     DELETE FROM YK_LDZC_TEMP WHERE XTXH = P_XTXH;
"
YK_LDZC_GHDW	PROCEDURE	44	"
"
YK_LDZC_GHDW	PROCEDURE	45	"---- START
"
YK_LDZC_GHDW	PROCEDURE	46	"  OPEN CUR_LDZC_GHDW;
"
YK_LDZC_GHDW	PROCEDURE	47	"  LOOP
"
YK_LDZC_GHDW	PROCEDURE	48	"       FETCH CUR_LDZC_GHDW INTO V_RKDH,V_CRKFSDM,V_RKRQ,V_JZRQ,V_FKRQ,V_JSDH,V_YDZBZ,V_YFKBZ;
"
YK_LDZC_GHDW	PROCEDURE	49	"       EXIT WHEN CUR_LDZC_GHDW%NOTFOUND;
"
YK_LDZC_GHDW	PROCEDURE	50	"
"
YK_LDZC_GHDW	PROCEDURE	51	"-- JJHS
"
YK_LDZC_GHDW	PROCEDURE	52	"       BEGIN
"
YK_LDZC_GHDW	PROCEDURE	53	"        SELECT JJHS INTO V_JJHS
"
YK_LDZC_GHDW	PROCEDURE	54	"        FROM YK_CRKFS
"
YK_LDZC_GHDW	PROCEDURE	55	"        WHERE XTXH = P_XTXH AND KCFX = 1 AND CRKFSDM = V_CRKFSDM;
"
YK_LDZC_GHDW	PROCEDURE	56	"        EXCEPTION      
"
YK_LDZC_GHDW	PROCEDURE	57	"	    WHEN NO_DATA_FOUND THEN
"
YK_LDZC_GHDW	PROCEDURE	58	"            V_JJHS := 1;
"
YK_LDZC_GHDW	PROCEDURE	59	"       END;
"
YK_LDZC_GHDW	PROCEDURE	60	"
"
YK_LDZC_GHDW	PROCEDURE	61	"-- DWMC    
"
YK_LDZC_GHDW	PROCEDURE	62	"       BEGIN
"
YK_LDZC_GHDW	PROCEDURE	63	"        SELECT DWMC,NVL(YFKPB,0) INTO V_DWMC,V_YFKPB
"
YK_LDZC_GHDW	PROCEDURE	64	"        FROM YK_JHDW
"
YK_LDZC_GHDW	PROCEDURE	65	"        WHERE XTXH = P_XTXH AND DWBH = P_DWBH;
"
YK_LDZC_GHDW	PROCEDURE	66	"        EXCEPTION      
"
YK_LDZC_GHDW	PROCEDURE	67	"	    WHEN NO_DATA_FOUND THEN
"
YK_LDZC_GHDW	PROCEDURE	68	"            V_DWMC := '错误';
"
YK_LDZC_GHDW	PROCEDURE	69	"            V_YFKPB := 0;
"
YK_LDZC_GHDW	PROCEDURE	70	"       END;
"
YK_LDZC_GHDW	PROCEDURE	71	"
"
YK_LDZC_GHDW	PROCEDURE	72	"-- QTPB     
"
YK_LDZC_GHDW	PROCEDURE	73	"       BEGIN
"
YK_LDZC_GHDW	PROCEDURE	74	"        SELECT NVL(QTPB,0) INTO V_QTPB
"
YK_LDZC_GHDW	PROCEDURE	75	"        FROM YK_CRKFS
"
YK_LDZC_GHDW	PROCEDURE	76	"        WHERE XTXH = P_XTXH AND CRKFSDM = V_CRKFSDM;
"
YK_LDZC_GHDW	PROCEDURE	77	"        EXCEPTION      
"
YK_LDZC_GHDW	PROCEDURE	78	"	    WHEN NO_DATA_FOUND THEN
"
YK_LDZC_GHDW	PROCEDURE	79	"            V_QTPB := 0;
"
YK_LDZC_GHDW	PROCEDURE	80	"       END;
"
YK_LDZC_GHDW	PROCEDURE	81	"
"
YK_LDZC_GHDW	PROCEDURE	82	"--应付款判别
"
YK_LDZC_GHDW	PROCEDURE	83	"      IF V_QTPB = 1 AND V_YFKPB = 1 THEN
"
YK_LDZC_GHDW	PROCEDURE	84	"         V_YFKPB := 1;
"
YK_LDZC_GHDW	PROCEDURE	85	"      ELSE
"
YK_LDZC_GHDW	PROCEDURE	86	"         V_YFKPB := 0;
"
YK_LDZC_GHDW	PROCEDURE	87	"      END IF;
"
YK_LDZC_GHDW	PROCEDURE	88	"--
"
YK_LDZC_GHDW	PROCEDURE	89	"
"
YK_LDZC_GHDW	PROCEDURE	90	"      BEGIN
"
YK_LDZC_GHDW	PROCEDURE	91	"       SELECT SUM(ROUND(NVL(JJ,0)*RKSL,2)),SUM(ROUND(NVL(PFJ,0)*RKSL,2)),
"
YK_LDZC_GHDW	PROCEDURE	92	"              SUM(ROUND(NVL(LSJ,0)*RKSL,2))
"
YK_LDZC_GHDW	PROCEDURE	93	"       INTO V_JJJE,V_PFJE,V_LSJE
"
YK_LDZC_GHDW	PROCEDURE	94	"       FROM YK_YPRKDMX 
"
YK_LDZC_GHDW	PROCEDURE	95	"       WHERE XTXH = P_XTXH AND RKDH = V_RKDH AND CRKFSDM = V_CRKFSDM;
"
YK_LDZC_GHDW	PROCEDURE	96	"       EXCEPTION      
"
YK_LDZC_GHDW	PROCEDURE	97	"	   WHEN NO_DATA_FOUND THEN
"
YK_LDZC_GHDW	PROCEDURE	98	"           V_JJJE := 0;
"
YK_LDZC_GHDW	PROCEDURE	99	"           V_PFJE := 0;
"
YK_LDZC_GHDW	PROCEDURE	100	"           V_LSJE := 0;
"
YK_LDZC_GHDW	PROCEDURE	101	"      END;
"
YK_LDZC_GHDW	PROCEDURE	102	"
"
YK_LDZC_GHDW	PROCEDURE	103	"-- 发票
"
YK_LDZC_GHDW	PROCEDURE	104	"      BEGIN
"
YK_LDZC_GHDW	PROCEDURE	105	"       SELECT COUNT(*)  INTO V_COUNT1
"
YK_LDZC_GHDW	PROCEDURE	106	"       FROM YK_YPRKDMX 
"
YK_LDZC_GHDW	PROCEDURE	107	"       WHERE XTXH = P_XTXH AND RKDH = V_RKDH AND CRKFSDM = V_CRKFSDM ;
"
YK_LDZC_GHDW	PROCEDURE	108	"       EXCEPTION      
"
YK_LDZC_GHDW	PROCEDURE	109	"	   WHEN NO_DATA_FOUND THEN
"
YK_LDZC_GHDW	PROCEDURE	110	"           V_COUNT1 := -1;
"
YK_LDZC_GHDW	PROCEDURE	111	"      END;
"
YK_LDZC_GHDW	PROCEDURE	112	"
"
YK_LDZC_GHDW	PROCEDURE	113	"      BEGIN
"
YK_LDZC_GHDW	PROCEDURE	114	"       SELECT COUNT(*)  INTO V_COUNT2
"
YK_LDZC_GHDW	PROCEDURE	115	"       FROM YK_YPRKDMX 
"
YK_LDZC_GHDW	PROCEDURE	116	"       WHERE XTXH = P_XTXH AND RKDH = V_RKDH AND CRKFSDM = V_CRKFSDM  
"
YK_LDZC_GHDW	PROCEDURE	117	"       AND FPHM IS NOT NULL AND LENGTH(LTRIM(RTRIM(FPHM))) <> 0;
"
YK_LDZC_GHDW	PROCEDURE	118	"       EXCEPTION      
"
YK_LDZC_GHDW	PROCEDURE	119	"	   WHEN NO_DATA_FOUND THEN
"
YK_LDZC_GHDW	PROCEDURE	120	"           V_COUNT2 := -1;
"
YK_LDZC_GHDW	PROCEDURE	121	"      END;
"
YK_LDZC_GHDW	PROCEDURE	122	"
"
YK_LDZC_GHDW	PROCEDURE	123	"-- 2 已到 ; 1 部分到 ; 0 未到 ; -1 错误 ;3 无 (如赠品入库)
"
YK_LDZC_GHDW	PROCEDURE	124	"      
"
YK_LDZC_GHDW	PROCEDURE	125	"      IF V_COUNT2 > 0 THEN
"
YK_LDZC_GHDW	PROCEDURE	126	"         IF V_COUNT2 = V_COUNT1 THEN
"
YK_LDZC_GHDW	PROCEDURE	127	"            V_FPHM := 2;
"
YK_LDZC_GHDW	PROCEDURE	128	"         ELSE
"
YK_LDZC_GHDW	PROCEDURE	129	"            V_FPHM := 1;
"
YK_LDZC_GHDW	PROCEDURE	130	"         END IF;
"
YK_LDZC_GHDW	PROCEDURE	131	"      ELSIF V_COUNT2 = 0 THEN
"
YK_LDZC_GHDW	PROCEDURE	132	"         V_FPHM := 0;
"
YK_LDZC_GHDW	PROCEDURE	133	"      ELSE
"
YK_LDZC_GHDW	PROCEDURE	134	"         V_FPHM := -1;
"
YK_LDZC_GHDW	PROCEDURE	135	"      END IF;
"
YK_LDZC_GHDW	PROCEDURE	136	"
"
YK_LDZC_GHDW	PROCEDURE	137	"      IF V_JJHS = 0 THEN
"
YK_LDZC_GHDW	PROCEDURE	138	"         V_FPHM := 3;
"
YK_LDZC_GHDW	PROCEDURE	139	"	 V_JXCE := V_LSJE - V_PFJE;
"
YK_LDZC_GHDW	PROCEDURE	140	"         V_PLCE := V_LSJE - V_PFJE;
"
YK_LDZC_GHDW	PROCEDURE	141	"         V_RLCE := 0;
"
YK_LDZC_GHDW	PROCEDURE	142	"      ELSE
"
YK_LDZC_GHDW	PROCEDURE	143	"	 V_JXCE := V_LSJE - V_JJJE;
"
YK_LDZC_GHDW	PROCEDURE	144	"         V_PLCE := V_LSJE - V_PFJE;
"
YK_LDZC_GHDW	PROCEDURE	145	"         V_RLCE := V_PFJE - V_JJJE;
"
YK_LDZC_GHDW	PROCEDURE	146	"      END IF;
"
YK_LDZC_GHDW	PROCEDURE	147	"
"
YK_LDZC_GHDW	PROCEDURE	148	"      INSERT INTO YK_LDZC_TEMP 	
"
YK_LDZC_GHDW	PROCEDURE	149	"(XTXH,RKDH,CRKFSDM,DWBH,DWMC,JJJE,PFJE,LSJE,RKRQ,JZRQ,FKRQ,JSDH,YDZBZ,YFKBZ,FPHM,YFKPB,PLCE,JXCE,RLCE)
"
YK_LDZC_GHDW	PROCEDURE	150	"VALUES
"
YK_LDZC_GHDW	PROCEDURE	151	"(P_XTXH,V_RKDH,V_CRKFSDM,P_DWBH,V_DWMC,
"
YK_LDZC_GHDW	PROCEDURE	152	"V_JJJE,V_PFJE,V_LSJE,V_RKRQ,V_JZRQ,V_FKRQ,V_JSDH,V_YDZBZ,V_YFKBZ,V_FPHM,V_YFKPB,V_PLCE,V_JXCE,V_RLCE);
"
YK_LDZC_GHDW	PROCEDURE	153	"
"
YK_LDZC_GHDW	PROCEDURE	154	"   END LOOP;
"
YK_LDZC_GHDW	PROCEDURE	155	"   CLOSE CUR_LDZC_GHDW;
"
YK_LDZC_GHDW	PROCEDURE	156	"
"
YK_LDZC_GHDW	PROCEDURE	157	"--COMMIT;
"
YK_LDZC_GHDW	PROCEDURE	158	"EXCEPTION  -- exception handlers begin
"
YK_LDZC_GHDW	PROCEDURE	159	"   WHEN OTHERS THEN  -- handles all other errors
"
YK_LDZC_GHDW	PROCEDURE	160	"        ROLLBACK;
"
YK_LDZC_GHDW	PROCEDURE	161	"	RAISE_APPLICATION_ERROR(-20103,'YK_LDZC_GHDW FAILS');
"
YK_LDZC_GHDW	PROCEDURE	162	"
"
YK_LDZC_GHDW	PROCEDURE	163	"END;
"
YK_LDZC_GHDW	PROCEDURE	164	"END;
"
YK_LDZC_GHDW	PROCEDURE	165	"
"
YK_LDZC_GHDW	PROCEDURE	166	"
"
YK_LDZC_GHDW	PROCEDURE	167	"
"
YK_LDZC_GHDW	PROCEDURE	168	 
