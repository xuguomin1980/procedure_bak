YK_YPTJ	PROCEDURE	1	"PROCEDURE         ""YK_YPTJ"" (YTJDH IN VARCHAR2,YJZR IN VARCHAR2,SDATE IN VARCHAR2,VXTXH in NUMBER)
"
YK_YPTJ	PROCEDURE	2	"IS
"
YK_YPTJ	PROCEDURE	3	"   I NUMBER ;
"
YK_YPTJ	PROCEDURE	4	"   J NUMBER ;
"
YK_YPTJ	PROCEDURE	5	"   JZDATE DATE ;
"
YK_YPTJ	PROCEDURE	6	"   VYPSX  CHAR(11) ;
"
YK_YPTJ	PROCEDURE	7	"   VXYTJDH VARCHAR2(10);
"
YK_YPTJ	PROCEDURE	8	"   VZYTJDH VARCHAR2(10);
"
YK_YPTJ	PROCEDURE	9	"   VCYTJDH VARCHAR2(10);
"
YK_YPTJ	PROCEDURE	10	"   VXYTJDH1 VARCHAR2(10);
"
YK_YPTJ	PROCEDURE	11	"   VZYTJDH1 VARCHAR2(10);
"
YK_YPTJ	PROCEDURE	12	"   VCYTJDH1 VARCHAR2(10);
"
YK_YPTJ	PROCEDURE	13	"   XYPXH NUMBER(6) ;
"
YK_YPTJ	PROCEDURE	14	"   FZYPXH NUMBER(6) ;
"
YK_YPTJ	PROCEDURE	15	"   XYPCDDM NUMBER(4) ;
"
YK_YPTJ	PROCEDURE	16	"   XCRKFSDM NUMBER(2);
"
YK_YPTJ	PROCEDURE	17	"   XJX NUMBER(2);
"
YK_YPTJ	PROCEDURE	18	"   XTJSL NUMBER ;
"
YK_YPTJ	PROCEDURE	19	"   XTJDH VARCHAR2(8) ;
"
YK_YPTJ	PROCEDURE	20	"   XTJWH VARCHAR2(20) ;
"
YK_YPTJ	PROCEDURE	21	"   YFTJDH VARCHAR2(10) ;
"
YK_YPTJ	PROCEDURE	22	"   YFKSDM VARCHAR2(10) ;
"
YK_YPTJ	PROCEDURE	23	"   YFTJSL NUMBER ;
"
YK_YPTJ	PROCEDURE	24	"   VYPLB  NUMBER ;
"
YK_YPTJ	PROCEDURE	25	"   VYFLB  NUMBER ;
"
YK_YPTJ	PROCEDURE	26	"   YFTJDH1 VARCHAR2(10) ;
"
YK_YPTJ	PROCEDURE	27	"   YFKSDM1 VARCHAR2(10) ;
"
YK_YPTJ	PROCEDURE	28	"   YFPB    VARCHAR2(6) ;
"
YK_YPTJ	PROCEDURE	29	"   VNEW    NUMBER;
"
YK_YPTJ	PROCEDURE	30	"   YFTJSL1 NUMBER ;
"
YK_YPTJ	PROCEDURE	31	"   XZY VARCHAR2(40);
"
YK_YPTJ	PROCEDURE	32	"   YKBZL NUMBER(4) ;
"
YK_YPTJ	PROCEDURE	33	"   VJGXH NUMBER ;
"
YK_YPTJ	PROCEDURE	34	"   OLDLSJ NUMBER ;
"
YK_YPTJ	PROCEDURE	35	"   OLDPFJ NUMBER ;
"
YK_YPTJ	PROCEDURE	36	"   NEWLSJ NUMBER ;
"
YK_YPTJ	PROCEDURE	37	"   NEWPFJ NUMBER ;
"
YK_YPTJ	PROCEDURE	38	"   LSSJJE NUMBER ;         --零售升降金额
"
YK_YPTJ	PROCEDURE	39	"   PFSJJE NUMBER ;         --批发升降金额
"
YK_YPTJ	PROCEDURE	40	"   YFXTXH NUMBER ;
"
YK_YPTJ	PROCEDURE	41	"   XYFLB  NUMBER ;
"
YK_YPTJ	PROCEDURE	42	"   XRKMS  NUMBER ;
"
YK_YPTJ	PROCEDURE	43	"   XCKMS  NUMBER ;
"
YK_YPTJ	PROCEDURE	44	"   XDQH VARCHAR2(4);
"
YK_YPTJ	PROCEDURE	45	"   CURSOR TJYPCUR IS 
"
YK_YPTJ	PROCEDURE	46	"      SELECT JGXH,YPXH,YPCDDM,TJSL,YPFJ,YLSJ,XPFJ,XLSJ,ZBLB
"
YK_YPTJ	PROCEDURE	47	"        FROM YK_YKTJDMX WHERE XTXH=VXTXH AND TJDH=XTJDH;   
"
YK_YPTJ	PROCEDURE	48	"   CURSOR ZXGGCUR IS
"
YK_YPTJ	PROCEDURE	49	"      SELECT YPXH FROM GY_YPMCGGZD WHERE FZFL=XYPXH ;  
"
YK_YPTJ	PROCEDURE	50	"   CURSOR YFXHCUR IS
"
YK_YPTJ	PROCEDURE	51	"      SELECT XTXH FROM YF_YPLXDZ WHERE YPLX=VYPLB ;	
"
YK_YPTJ	PROCEDURE	52	"BEGIN
"
YK_YPTJ	PROCEDURE	53	"   UPDATE GY_XTCS SET CSZ1=NULL WHERE XTXH=VXTXH AND CSMC='TJDH' ;
"
YK_YPTJ	PROCEDURE	54	"-- COMMIT ;
"
YK_YPTJ	PROCEDURE	55	"   JZDATE:=TO_DATE(SDATE,'YYYY-MM-DD HH24:MI') ;
"
YK_YPTJ	PROCEDURE	56	"   XCRKFSDM:=21  ;           			    --调价
"
YK_YPTJ	PROCEDURE	57	"   I:=0 ;
"
YK_YPTJ	PROCEDURE	58	"   LOCK TABLE YK_CRKFS IN EXCLUSIVE MODE ;
"
YK_YPTJ	PROCEDURE	59	"   SELECT LPAD(DQDH+1,8,'0') INTO XTJDH 
"
YK_YPTJ	PROCEDURE	60	"     FROM YK_CRKFS WHERE XTXH=VXTXH AND CRKFSDM=XCRKFSDM ;
"
YK_YPTJ	PROCEDURE	61	"     							    --如TJDH不够八位,在左侧用零补足
"
YK_YPTJ	PROCEDURE	62	"   UPDATE YK_CRKFS SET DQDH=XTJDH WHERE XTXH=VXTXH AND CRKFSDM=XCRKFSDM ;
"
YK_YPTJ	PROCEDURE	63	"   UPDATE YK_YKTJD SET TJDH=XTJDH,JZR=YJZR,ZXRQ=JZDATE,YSDJH=YTJDH 
"
YK_YPTJ	PROCEDURE	64	"   WHERE XTXH=VXTXH AND TJDH=YTJDH;
"
YK_YPTJ	PROCEDURE	65	"   UPDATE YK_YKTJDMX SET TJDH=XTJDH WHERE XTXH=VXTXH AND TJDH=YTJDH;
"
YK_YPTJ	PROCEDURE	66	"   SELECT TJWH INTO XTJWH FROM YK_YKTJD WHERE XTXH=VXTXH AND TJDH=XTJDH ;
"
YK_YPTJ	PROCEDURE	67	"   YFPB:='000000';
"
YK_YPTJ	PROCEDURE	68	"   OPEN TJYPCUR ;
"
YK_YPTJ	PROCEDURE	69	"   LOOP
"
YK_YPTJ	PROCEDURE	70	"     FETCH TJYPCUR INTO VJGXH,XYPXH,XYPCDDM,XTJSL,OLDPFJ,OLDLSJ,NEWPFJ,NEWLSJ,XJX ;
"
YK_YPTJ	PROCEDURE	71	"     EXIT WHEN TJYPCUR%NOTFOUND ;
"
YK_YPTJ	PROCEDURE	72	"     I:=I+1;
"
YK_YPTJ	PROCEDURE	73	"     LSSJJE:=(NEWLSJ-OLDLSJ)*XTJSL;
"
YK_YPTJ	PROCEDURE	74	"     PFSJJE:=(NEWPFJ-OLDPFJ)*XTJSL;
"
YK_YPTJ	PROCEDURE	75	"     IF LSSJJE>0 THEN
"
YK_YPTJ	PROCEDURE	76	"		  XZY:='调升(从'||OLDLSJ||'到'||NEWLSJ||') 数量:'||XTJSL ;
"
YK_YPTJ	PROCEDURE	77	"	     INSERT INTO YK_KCMXZB 
"
YK_YPTJ	PROCEDURE	78	"	         (XTXH,CRKFSDM,CRKDH,YPXH,YPCDDM,RQ,ZY,JFSL,JFDJ,JFJE,DFSL,DFDJ,DFJE,ZBLB)
"
YK_YPTJ	PROCEDURE	79	"	     VALUES (VXTXH,XCRKFSDM,XTJDH,XYPXH,XYPCDDM,JZDATE,XZY,0,0,LSSJJE,0,0,0,XJX) ;
"
YK_YPTJ	PROCEDURE	80	"     ELSE 
"
YK_YPTJ	PROCEDURE	81	"		  XZY:='调降(从'||OLDLSJ||'到'||NEWLSJ||') 数量:'||XTJSL ;
"
YK_YPTJ	PROCEDURE	82	"        INSERT INTO YK_KCMXZB 
"
YK_YPTJ	PROCEDURE	83	"               (XTXH,CRKFSDM,CRKDH,YPXH,YPCDDM,RQ,ZY,JFSL,JFDJ,JFJE,DFSL,DFDJ,DFJE,ZBLB)
"
YK_YPTJ	PROCEDURE	84	"        VALUES (VXTXH,XCRKFSDM,XTJDH,XYPXH,XYPCDDM,JZDATE,XZY,0,0,0,0,0,-1*LSSJJE,XJX) ;
"
YK_YPTJ	PROCEDURE	85	"     END IF ;
"
YK_YPTJ	PROCEDURE	86	"     INSERT INTO YK_YPMXZ (XTXH,CRKFSDM,CRKDH,XH,JGXH,YPXH,YPCDDM,RQ,ZY,PFJ,LSJ,ZBLB)
"
YK_YPTJ	PROCEDURE	87	"       VALUES (VXTXH,XCRKFSDM,XTJDH,I,VJGXH,XYPXH,XYPCDDM,JZDATE,XZY,PFSJJE,LSSJJE,XJX);
"
YK_YPTJ	PROCEDURE	88	"     SELECT YPBZL INTO YKBZL FROM GY_YPMCGGZD WHERE YPXH=XYPXH ;
"
YK_YPTJ	PROCEDURE	89	"     UPDATE GY_YPCDJG SET PFJ=NEWPFJ,LSJ=NEWLSJ WHERE YPXH=XYPXH AND YPCDDM=XYPCDDM ;
"
YK_YPTJ	PROCEDURE	90	"     OPEN ZXGGCUR ;
"
YK_YPTJ	PROCEDURE	91	"     LOOP
"
YK_YPTJ	PROCEDURE	92	"       FETCH ZXGGCUR INTO FZYPXH ;
"
YK_YPTJ	PROCEDURE	93	"       EXIT WHEN ZXGGCUR%NOTFOUND ;
"
YK_YPTJ	PROCEDURE	94	"       UPDATE GY_YPCDJG SET PFJ=NEWPFJ/YKBZL,LSJ=ROUND(NEWLSJ/YKBZL,3)  
"
YK_YPTJ	PROCEDURE	95	"          WHERE YPXH=FZYPXH AND YPCDDM=XYPCDDM;
"
YK_YPTJ	PROCEDURE	96	"       UPDATE GY_YPCDJG SET PFJ=NEWPFJ/YKBZL*YPBZL,LSJ=ROUND(NEWLSJ/YKBZL*YPBZL,3) 
"
YK_YPTJ	PROCEDURE	97	"          WHERE FZFL=FZYPXH AND YPCDDM=XYPCDDM;
"
YK_YPTJ	PROCEDURE	98	"     END LOOP ;
"
YK_YPTJ	PROCEDURE	99	"     CLOSE ZXGGCUR ;
"
YK_YPTJ	PROCEDURE	100	"     SELECT CSZ2 INTO XRKMS FROM GY_XTCS WHERE XTXH=VXTXH AND CSMC='RKMS';
"
YK_YPTJ	PROCEDURE	101	"     SELECT CSZ2 INTO XCKMS FROM GY_XTCS WHERE XTXH=VXTXH AND CSMC='CKMS';
"
YK_YPTJ	PROCEDURE	102	"     IF XRKMS=1 THEN
"
YK_YPTJ	PROCEDURE	103	"	     UPDATE YK_YPRKDMX SET PFJ=NEWPFJ,LSJ=NEWLSJ,       --将已经制单但未登帐的单据调价
"
YK_YPTJ	PROCEDURE	104	"            KL=ROUND(JJ/NEWPFJ,2)
"
YK_YPTJ	PROCEDURE	105	"	     WHERE XTXH=VXTXH AND YPXH=XYPXH AND YPCDDM=XYPCDDM AND NVL(YDZBZ,0)=0 ;
"
YK_YPTJ	PROCEDURE	106	"     END IF;
"
YK_YPTJ	PROCEDURE	107	"     IF XCKMS=1 THEN
"
YK_YPTJ	PROCEDURE	108	"	     UPDATE YK_YPCKDMX SET LSJ=NEWLSJ     		   --将已经制单但未登帐的单据调价
"
YK_YPTJ	PROCEDURE	109	"   	    WHERE XTXH=VXTXH AND YPXH=XYPXH AND YPCDDM=XYPCDDM AND NVL(YDZBZ,0)=0 ;
"
YK_YPTJ	PROCEDURE	110	"     END IF;
"
YK_YPTJ	PROCEDURE	111	"     UPDATE YK_YPKCZB SET PFJ=NEWPFJ,LSJ=NEWLSJ
"
YK_YPTJ	PROCEDURE	112	"       WHERE XTXH=VXTXH AND YPXH=XYPXH AND YPCDDM=XYPCDDM ;
"
YK_YPTJ	PROCEDURE	113	"  END LOOP;
"
YK_YPTJ	PROCEDURE	114	"   CLOSE TJYPCUR ;
"
YK_YPTJ	PROCEDURE	115	"   UPDATE GY_XTCS SET CSZ1=XTJDH WHERE XTXH=VXTXH AND CSMC='TJDH'; 
"
YK_YPTJ	PROCEDURE	116	"          --将新生成的调价单号放入参数表中,供程序中调用
"
YK_YPTJ	PROCEDURE	117	"   UPDATE GY_XTCS SET CSZ2=0 WHERE XTXH=VXTXH AND CSMC='ISTJ'; --将参数表的调价标志置否
"
YK_YPTJ	PROCEDURE	118	" END;
"
YK_YPTJ	PROCEDURE	119	"
"
YK_YPTJ	PROCEDURE	120	"
"
YK_YPTJ	PROCEDURE	121	"
"
YK_YPTJ	PROCEDURE	122	 
